name: Actualizar archivos hosts personalizados

on:
  push:
    paths:
      - "hosts"  # Se ejecuta solo cuando se modifica el archivo principal
  workflow_dispatch:  # Permite ejecutarlo manualmente desde GitHub Actions

jobs:
  update-hosts:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v4

      - name: Ejecutar el script de sincronizaci칩n
        run: |
          echo '#!/bin/bash
          MAIN_HOSTS="hosts"

          # Buscar archivos que comiencen con "US"
          CUSTOM_FILES=($(find . -maxdepth 1 -type f -name "US*"))

          # Si no hay archivos personalizados, salir sin error
          if [ ${#CUSTOM_FILES[@]} -eq 0 ]; then
              echo "No se encontraron archivos US*, saliendo..."
              exit 0
          fi

          # Recorrer cada archivo personalizado y actualizarlo
          for CUSTOM_FILE in "${CUSTOM_FILES[@]}"; do
              echo "Actualizando $CUSTOM_FILE..."

              # Crear el archivo si no existe
              if [ ! -f "$CUSTOM_FILE" ]; then
                  cp "$MAIN_HOSTS" "$CUSTOM_FILE"
                  echo "# Personalizaci칩n espec칤fica para $CUSTOM_FILE" >> "$CUSTOM_FILE"
                  continue
              fi

              # Crear archivo temporal para manejar modificaciones
              TEMP_FILE=$(mktemp)

              # Analizar el archivo principal, ignorando l칤neas comentadas
              while IFS= read -r line; do
                  # Ignorar l칤neas comentadas en el archivo principal
                  [[ "$line" =~ ^#.*$ ]] && continue

                  HOST_KEY=$(echo "$line" | awk '{print $2}')

                  # Verificar si la l칤nea existe comentada en el archivo personalizado
                  if grep -q "^#.*\\s$HOST_KEY$" "$CUSTOM_FILE"; then
                      echo "L칤nea comentada con $HOST_KEY encontrada en $CUSTOM_FILE. Ignorando actualizaci칩n y no a침adiendo duplicado."
                      continue
                  fi

                  # Si la l칤nea existe sin comentar, eliminarla antes de a침adir la nueva versi칩n
                  if grep -q "^[^#].*\\s$HOST_KEY$" "$CUSTOM_FILE"; then
                      sed -i "/^[^#].*\\s$HOST_KEY$/d" "$CUSTOM_FILE"
                  fi

                  # A침adir la l칤nea si no est치 comentada
                  if ! grep -q "\\s$HOST_KEY$" "$CUSTOM_FILE"; then
                      echo "$line" >> "$TEMP_FILE"
                  fi
              done < "$MAIN_HOSTS"

              # A침adir l칤neas personalizadas antiguas que no est칠n en el nuevo archivo temporal
              grep -vxFf "$TEMP_FILE" "$CUSTOM_FILE" >> "$TEMP_FILE"

              mv "$TEMP_FILE" "$CUSTOM_FILE"
              echo "Actualizaci칩n completada para $CUSTOM_FILE."
          done
          ' > update_hosts.sh

          chmod +x update_hosts.sh
          ./update_hosts.sh

      - name: Subir cambios si hay modificaciones
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"

          git add .
          if git diff --cached --quiet; then
            echo "No hay cambios en los archivos US*, saliendo..."
            exit 0
          fi

          git commit -m "游 Actualizaci칩n autom치tica de archivos hosts personalizados (ignora y previene duplicados de l칤neas comentadas)"
          git push
